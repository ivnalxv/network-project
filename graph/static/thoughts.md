>Рассматривается топология тор. Измерения тора для простоты именуются [X, Y, Z, K, L]. Узел сети в каждом измерении соединяется c двумя узлами в соответствующих направлениях по измерению: +X, -X; +Y, -Y и т.д.
Замечание: узел в одном из направлений может отсутствовать.
>
>Имеется двухпортовый сетевой адаптер, каждый порт которого содержит +X,+Y и -X, -Y.
>
>Коммутатор сети Альфа представляет собой 4 узла сети, объединенных в кольцо по измерению L. Каждый узел коммутатора имеет 4 независимых Crosspoint-а. Каждый порт 32-портового коммутатора представляет собой 4 одноименных направления для каждого из Crosspoint-ов. 


### 2.1. Маршрутизация

Маршрут пакета в сети Альфа задается набором дельт.

Каждое такое поле пакета отображает, какое количество шагов (дельт) пакет обязан пройти по данному направлению. Также во всех маршрутизаторах задан одинаковый порядок направлений, в котором перебираются дельты при маршрутизации пакетов.

Сетевой пакет проходит последовательно все направления (в заданном порядке), для которых указано ненулевое число шагов. Пакет может перейти в следующее направление, только когда пройдены шаги во всех предыдущих. Пакет эжектируется, когда для всех направлений количество шагов равно 0.


Существуют следующие ограничения:
- Количество шагов (дельт) в каждом направлении имеет ограничение:
- 7 шагов для направлений: +X,-X,+Y,-Y (3 бита на поле)
- 3 шага для направлений: +Z,-Z,+K,-K,+L,-L. (2 бита на поле)

Также присутствует возможность задать "Первый шаг пакета". Шаг пакета настраивается аппаратно. Существует по две отдельные настройки для четных и нечетных конвейеров в сетевом адаптере. Каждая из настроек позволяет добавить "один шаг" к пакету, где "один шаг": или номер направления; или отсутствие шага.

Выбор настройки зависит от бита в заголовочном флите (также существует бит, который говорит не принимать ни одну из настроек).

###  2.2. Таблица маршрутов
Рассмотрим коммуникационную сеть с измерениями (d1, d2, …, dn), рассмотрим множество узлов M = Ma + Mt, где Ma — множество активных узлов, Mt — множество транзитных узлов. Активные узлы - это узлы, которые осуществляют отправку (инжекцию пакетов) и прием (эжекцию пакетов). Транзитные узлы не осуществляют отправку, но передают сетевые пакеты через себя.

Узел сети A достижим из узла сети B, если есть маршрут из B в А. Достижимость множества узлов M - из каждого узла множества Ma есть маршрут до каждого узла из Ma.

Таблицей маршрутов для множества M назовем набор дельт, описывающих маршруты от каждого узла u из множества Ma к каждому узлу v из того же множества.

За качество построенной таблицы маршрутов примем максимальную загруженность канала связи. Максимальная загруженность канала связи - это число маршрутов, проходящих через этот канал связи.
Заметим, что каналы связи двунаправленные, так загрузка канала (1) -> (0) не связана с загрузкой (0) -> (1).

Замечание: Минимизация максимальной загруженности каналов позволяет получить равномерно загруженную систему. 


### Схема решения:
1. Преобразовать входное описание в граф сети 5D-тор. Но чтобы при этом легко было выяснить, к какому узлу или коммутатору относится каждая  вершина.
2. По графу сети 5D-тор построить Channel Dependency Graph (CDG).
3. С помощью CDG построить маршруты и определить достижимость сети.

Входные данные:
- Порядок направлений
- Топология сети в json-формате

Рекомендуемые порядки направлений:
- sw32p - +L-L+X+Y+Z+K-X-Y-Z-K (1 коммутатор)
- sw24p - +K+L-K-L+X+Y+Z-X-Y-Z (1D-кольцо из коммутаторов)
- sw16p - +Z+K+L-Z-K-L+X+Y-X-Y (2D-кольцо из коммутаторов)
- sw8p - +Y+Z+K+L-Y-Z-K-L+X-X (3D-кольцо из коммутаторов)

Нумерация портов адаптера и коммутатора начинается с 1. Пример описания сети для топологии 1D из двух коммутаторов (по измерению К), к каждому из которых подсоединены 2 узла:

### Про построение CDG:
Хотел добавить, что правило порядка направлений очень простое: 

Из узла А можно идти в те узлы, которые находятся в направлениях больших либо равных 
по отношению к тому направлению, из которого пришли в узел А.

Это фактически и есть единственный принцип построения cdg графа для рассматриваемой сети.



### Сделать:

1. Картинка для графа в нормальном виде (+ссылка в mermaid)
2. Сделать ребра неориентированными
    - Иван, у меня вопрос - почему на этой картинке у вас ребра (линки) ориентированы?
    - В реальности они неориентированы.
    - Линки в обратную сторону - это просто линки тора; если бы было 3 коммутатора в кольце,
    - это было бы более явно
3. В CDG мы должны игнорировать циклы по 1D-кольцам
    - В CDG мы должны игнорировать циклы по 1D-кольцам. Например, если для этой системы мы будем идти по кольцу в +К два шага,
    - то вернемся в тот же чип, из которого начали (не считая первого шага из узла в коммутатор).
    - Образуется цикл, но он разрешается при помощи правила "пузырька".
    - Сейчас не так важно, что это за правило, но важно, что такие циклы не приводят
    - к дедлокам в сети, их нужно игнорировать
    - Игнорировать - не учитывать такие ребра при поиске цикла

В общем, задание на эту неделю:
1) нужно поправить отмеченные недочеты. 
2) проверить наличие циклов с учетом правила "пузырька" в кольце. Хочется, чтобы циклы выводились сразу в двух форматах - в графе CDG и соответствующий ему цикл в графе сети
3) реализовать проверку достижимости узлов. Это грубо говоря из каждого узла нужно запустить поиск вширь (BFS) в графе CDG  и проверить, что достижимы все остальные узлы сети.
4) Также нужно подумать о том, как протестировать построение CDG. Возможный вариант - в качестве тестов нагенерировать простые сети-тесты с явной достижимостью и недостижимостью узлов. Сравнить результаты


Дописал в гугл доке фразу про 1D-кольцо: 

Отсутствие дедлоков в 1D-кольце обеспечивается при помощи пузырьковой маршрутизации,
в которой после прихода нового пакета в кольцо в этом кольце должно оставаться место
на еще один пакет максимальной длины, в таком случае движение пакетов в кольце всегда возможно.
